<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Active Trace ID Single-Page Demo</title>
  <style>
    :root {
      --paper: #fffdf7;
      --sand: #f2e9d8;
      --ocean: #0d5f6f;
      --ocean-2: #1b7f78;
      --clay: #b6522f;
      --ink: #1f2430;
      --muted: #4f5d68;
      --line: rgba(31, 36, 48, 0.18);
      --panel: rgba(255, 255, 255, 0.86);
      --ok: #0f7f56;
      --warn: #995f00;
      --err: #a11f28;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      color: var(--ink);
      background:
        radial-gradient(circle at 12% 12%, rgba(182, 82, 47, 0.28), transparent 32%),
        radial-gradient(circle at 86% 18%, rgba(13, 95, 111, 0.26), transparent 28%),
        linear-gradient(165deg, var(--paper), var(--sand));
      font-family: "Sora", "Avenir Next", "Segoe UI", sans-serif;
      min-height: 100vh;
    }

    .shell {
      max-width: 1380px;
      margin: 0 auto;
      padding: 1.4rem 1rem 2rem;
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.9rem;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 1rem;
      backdrop-filter: blur(5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
      animation: rise 240ms ease-out;
    }

    h1 {
      margin: 0;
      letter-spacing: 0.015em;
      font-size: 1.5rem;
    }

    .hero p {
      margin: 0.3rem 0 0;
      color: var(--muted);
      line-height: 1.45;
      max-width: 85ch;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.9rem;
    }

    .controls {
      display: grid;
      gap: 0.55rem;
    }

    .row {
      display: grid;
      gap: 0.35rem;
    }

    .calc-inline {
      display: grid;
      gap: 0.6rem;
      grid-template-columns: 1fr 130px 1fr;
      align-items: end;
    }

    .trace-flags-row {
      display: grid;
      gap: 0.6rem;
      grid-template-columns: minmax(320px, 1fr) auto;
      align-items: end;
    }

    .trace-base-inline {
      display: grid;
      gap: 0.45rem;
      grid-template-columns: 1fr auto;
      align-items: end;
    }

    .trace-base-inline label {
      grid-column: 1 / -1;
    }

    label,
    legend,
    .subtle {
      font-weight: 620;
      font-size: 0.9rem;
      color: #25303c;
    }

    input,
    select,
    button {
      font: inherit;
      border-radius: 11px;
      border: 1px solid var(--line);
      padding: 0.55rem 0.65rem;
      background: #fff;
      color: inherit;
    }

    button {
      cursor: pointer;
      border: none;
      color: #fff;
      background: linear-gradient(145deg, var(--ocean), var(--ocean-2));
      transition: transform 120ms ease-out, box-shadow 120ms ease-out;
      box-shadow: 0 6px 14px rgba(13, 95, 111, 0.26);
    }

    button:hover {
      transform: translateY(-1px);
    }

    .flags-inline {
      border: 1px solid var(--line);
      border-radius: 12px;
      display: flex;
      gap: 0.7rem;
      align-items: center;
      flex-wrap: wrap;
      padding: 0.5rem 0.65rem;
      background: rgba(255, 255, 255, 0.58);
    }

    .flag-item {
      display: flex;
      gap: 0.4rem;
      align-items: center;
      white-space: nowrap;
      font-size: 0.86rem;
    }

    code,
    pre,
    .mono {
      font-family: "IBM Plex Mono", "Cascadia Mono", "SFMono-Regular", monospace;
    }

    .trace-preview {
      padding: 0.7rem 0.8rem;
      border-left: 4px solid var(--clay);
      background: rgba(182, 82, 47, 0.07);
      border-radius: 8px;
      display: grid;
      gap: 0.3rem;
    }

    .trace-preview code {
      word-break: break-all;
    }

    .io h2,
    .logs h2,
    .history h2 {
      margin: 0.2rem 0 0.5rem;
      font-size: 1rem;
    }

    .logs-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.6rem;
      margin-bottom: 0.4rem;
    }

    .logs-head h2 {
      margin: 0;
    }

    .io-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.6rem;
    }

    pre {
      margin: 0;
      padding: 0.74rem;
      border: 1px solid var(--line);
      border-radius: 11px;
      background: #fcfdff;
      overflow: auto;
      font-size: 0.82rem;
      line-height: 1.4;
      min-height: 5.8rem;
    }

    .logs-view {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #0f1520;
      color: #dde7ff;
      min-height: 16rem;
      max-height: 24rem;
      overflow: auto;
      padding: 0.7rem;
    }

    .clear-btn {
      background: linear-gradient(145deg, #5f6a77, #4f5b69);
      box-shadow: 0 4px 11px rgba(32, 40, 52, 0.26);
      font-size: 0.84rem;
      padding: 0.45rem 0.62rem;
    }

    .log-line {
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.4;
      font-size: 0.81rem;
    }

    .log-level-INFO { color: #c6deff; }
    .log-level-DEBUG { color: #8ff2cc; }
    .log-level-WARN { color: #ffe09a; }
    .log-level-ERROR { color: #ffadb3; }

    .history ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 0.45rem;
    }

    .history li {
      border-left: 3px solid var(--ocean);
      background: rgba(13, 95, 111, 0.08);
      padding: 0.38rem 0.55rem;
      border-radius: 6px;
      font-size: 0.84rem;
    }

    .pill {
      border-radius: 999px;
      padding: 0.14rem 0.45rem;
      border: 1px solid var(--line);
      background: #fff;
      font-size: 0.76rem;
    }

    .ok { color: var(--ok); }
    .warn { color: var(--warn); }
    .err { color: var(--err); }

    @keyframes rise {
      from {
        opacity: 0;
        transform: translateY(7px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (min-width: 940px) {
      .io-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 940px) {
      .calc-inline {
        grid-template-columns: 1fr;
      }

      .trace-flags-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <main class="shell">
    <section class="panel hero">
      <h1>Active Trace ID: Browser-Only Demo</h1>
      <p>
        This version runs entirely in the browser as a single page. It simulates a calculator request flow, builds trace IDs with flags,
        and demonstrates runtime log behavior where <code>L</code> enables <code>DEBUG</code> lines for that request only.
      </p>
    </section>

    <section class="grid">
      <section class="panel controls">
        <div class="calc-inline">
          <div class="row">
            <label for="left">Left Operand</label>
            <input id="left" type="number" step="any" value="10">
          </div>
          <div class="row">
            <label for="operator">Operator</label>
            <select id="operator">
              <option value="+">+</option>
              <option value="-">-</option>
              <option value="*">*</option>
              <option value="/">/</option>
            </select>
          </div>
          <div class="row">
            <label for="right">Right Operand</label>
            <input id="right" type="number" step="any" value="2">
          </div>
        </div>

        <div class="trace-flags-row">
          <div class="trace-base-inline">
            <label for="traceBase">Base Trace ID</label>
            <input id="traceBase" type="text" autocomplete="off">
            <button id="regenTrace" type="button">New ID</button>
          </div>
          <div class="flags-inline" role="group" aria-label="Trace Flags">
            <label class="flag-item"><input id="flagL" type="checkbox"> <code>L</code> runtime debug logs</label>
            <label class="flag-item"><input id="flagD" type="checkbox"> <code>D</code> debug routing</label>
          </div>
        </div>

        <div class="trace-preview">
          <span class="subtle">Built Trace ID</span>
          <code id="tracePreview">-</code>
          <span id="debugState" class="pill">DEBUG disabled</span>
        </div>

        <button id="submit" type="button">Simulate Request</button>
      </section>

      <section class="panel logs">
        <div class="logs-head">
          <h2>Simulated Server Logs</h2>
          <button id="clearLogs" class="clear-btn" type="button">Clear Logs</button>
        </div>
        <div id="logsView" class="logs-view mono"></div>
      </section>
    </section>

    <section class="panel io">
      <h2>Request / Response Snapshot</h2>
      <div class="io-grid">
        <div>
          <div class="subtle">Request</div>
          <pre id="requestBox">No request yet.</pre>
        </div>
        <div>
          <div class="subtle">Response</div>
          <pre id="responseBox">No response yet.</pre>
        </div>
      </div>
    </section>

    <section class="panel history">
      <h2>Run History</h2>
      <ul id="history"></ul>
    </section>
  </main>

  <script>
    const left = document.getElementById("left");
    const right = document.getElementById("right");
    const operator = document.getElementById("operator");
    const traceBase = document.getElementById("traceBase");
    const flagL = document.getElementById("flagL");
    const flagD = document.getElementById("flagD");
    const tracePreview = document.getElementById("tracePreview");
    const debugState = document.getElementById("debugState");
    const submit = document.getElementById("submit");
    const regenTrace = document.getElementById("regenTrace");
    const requestBox = document.getElementById("requestBox");
    const responseBox = document.getElementById("responseBox");
    const history = document.getElementById("history");
    const logsView = document.getElementById("logsView");
    const clearLogs = document.getElementById("clearLogs");

    function randomTraceBase() {
      if (window.crypto && typeof window.crypto.randomUUID === "function") {
        return window.crypto.randomUUID();
      }
      return "trace-" + Date.now();
    }

    function selectedFlags() {
      const list = [];
      if (flagL.checked) list.push("L");
      if (flagD.checked) list.push("D");
      return list;
    }

    function buildTraceId() {
      const base = traceBase.value.trim();
      if (!base) return "";
      const flags = selectedFlags();
      return flags.length ? `${base}-${flags.join("")}` : base;
    }

    function updatePreview() {
      const traceId = buildTraceId();
      tracePreview.textContent = traceId || "(empty)";

      const debugEnabled = selectedFlags().includes("L");
      debugState.textContent = debugEnabled ? "DEBUG enabled" : "DEBUG disabled";
      debugState.className = "pill " + (debugEnabled ? "ok" : "warn");
    }

    function nowStamp() {
      return new Date().toISOString().replace("T", " ").replace("Z", "");
    }

    function appendLog(level, traceId, message) {
      const line = document.createElement("div");
      line.className = "log-line log-level-" + level;
      line.textContent = `${nowStamp()} ${level.padEnd(5, " ")} [trace=${traceId || "-"}] ${message}`;
      logsView.appendChild(line);
      logsView.scrollTop = logsView.scrollHeight;
    }

    function evalExpression(l, r, op) {
      switch (op) {
        case "+": return l + r;
        case "-": return l - r;
        case "*": return l * r;
        case "/": {
          if (r === 0) {
            throw new Error("Division by zero is not allowed.");
          }
          return l / r;
        }
        default:
          throw new Error("Unsupported operator: " + op);
      }
    }

    function formatNumber(value) {
      return Number.isInteger(value) ? String(value) : String(Number(value.toFixed(8)));
    }

    function toRequest(traceId) {
      return {
        method: "POST",
        url: "/api/calculate",
        headers: {
          "X-Trace-Id": traceId,
          "Content-Type": "application/json"
        },
        body: {
          left: Number(left.value),
          right: Number(right.value),
          operator: operator.value
        },
        simulated: true
      };
    }

    function addHistory(expression, result, traceId, flags) {
      const li = document.createElement("li");
      li.innerHTML = `<span class="mono">${new Date().toLocaleTimeString()} | ${expression} = ${result} | trace=${traceId}</span> <span class="pill">flags=${flags || "-"}</span>`;
      history.prepend(li);
    }

    function runSimulation() {
      const traceId = buildTraceId();
      if (!traceId) {
        responseBox.textContent = JSON.stringify({ error: "Base Trace ID is required." }, null, 2);
        appendLog("WARN", "-", "Cannot simulate request without base trace ID.");
        return;
      }

      const flags = selectedFlags().join("");
      const debugEnabled = flags.includes("L");
      const debugRoute = flags.includes("D");

      const req = toRequest(traceId);
      requestBox.textContent = JSON.stringify(req, null, 2);

      appendLog("INFO", traceId, "Incoming /api/calculate with flags=" + (flags || "-"));
      if (debugRoute) {
        appendLog("INFO", traceId, "Debug routing marker active: request would route to debug-capable pool.");
      }

      try {
        const l = req.body.left;
        const r = req.body.right;
        const op = req.body.operator;
        const result = evalExpression(l, r, op);
        const expression = `${formatNumber(l)} ${op} ${formatNumber(r)}`;

        if (debugEnabled) {
          appendLog("DEBUG", traceId, "Debug details: payload=" + JSON.stringify(req.body));
          appendLog("DEBUG", traceId, "Debug flags resolved: L=" + debugEnabled + " D=" + debugRoute);
        }

        appendLog("INFO", traceId, "Calculated expression=" + expression + " result=" + formatNumber(result));

        const res = {
          status: 200,
          body: {
            timestamp: new Date().toISOString(),
            expression,
            result,
            traceId,
            baseTraceId: traceBase.value.trim(),
            rawFlagSuffix: flags || null,
            knownFlags: selectedFlags(),
            debugLoggingEnabled: debugEnabled,
            debugBinaryRoutingEnabled: debugRoute,
            simulated: true
          }
        };

        responseBox.textContent = JSON.stringify(res, null, 2);
        addHistory(expression, formatNumber(result), traceId, flags);
      } catch (err) {
        appendLog("ERROR", traceId, "Rejected request: " + err.message);
        responseBox.textContent = JSON.stringify({ status: 400, body: { error: err.message, traceId, simulated: true } }, null, 2);
      }
    }

    function init() {
      traceBase.value = randomTraceBase();
      updatePreview();
      appendLog("INFO", "-", "Single-page simulator started.");
      appendLog("INFO", "-", "DEBUG lines are emitted only when L is present in the trace ID.");
    }

    traceBase.addEventListener("input", updatePreview);
    flagL.addEventListener("change", updatePreview);
    flagD.addEventListener("change", updatePreview);
    regenTrace.addEventListener("click", () => {
      traceBase.value = randomTraceBase();
      updatePreview();
    });
    submit.addEventListener("click", runSimulation);
    clearLogs.addEventListener("click", () => {
      logsView.innerHTML = "";
    });

    init();
  </script>
</body>
</html>
